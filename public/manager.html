<!DOCTYPE html>
<html lang="tr" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ãœretim MÃ¼dÃ¼rÃ¼ Paneli | YÃ¼kleme YÃ¶netim Sistemi</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="YÃ¼kleme YÃ¶netim Sistemi - Loading Management System">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="YÃ¼kleme">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#4f46e5">
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/icons/icon-96x96.png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- External Scripts -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <div class="header-logo">ğŸš›</div>
                    <div class="header-title">
                        <h1>YÃ¼kleme YÃ¶netim Sistemi</h1>
                        <span>YÃ¼kleme Belgesi</span>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="header-user">
                        <div class="header-user-avatar">ğŸ‘”</div>
                        <div class="header-user-info">
                            <span class="header-user-name" id="userName">Ãœretim MÃ¼dÃ¼rÃ¼</span>
                            <span class="header-user-role">Manager</span>
                        </div>
                    </div>
                    <button class="logout-btn" id="logoutBtn">
                        <span>Ã‡Ä±kÄ±ÅŸ Yap</span>
                        <span>ğŸšª</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">ğŸ“Š</div>
                    <div class="stat-info">
                        <h3 id="totalLoadings">0</h3>
                        <p>Toplam YÃ¼klemeler</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">ğŸ“…</div>
                    <div class="stat-info">
                        <h3 id="todayLoadings">0</h3>
                        <p>BugÃ¼nkÃ¼ YÃ¼klemeler</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon secondary">ğŸ•</div>
                    <div class="stat-info">
                        <h3 id="lastUpdate">--</h3>
                        <p>Son GÃ¼ncelleme</p>
                    </div>
                </div>
            </div>

            <!-- Loadings Table -->
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">
                        <span style="font-size: 24px;">ğŸ“‹</span>
                        <h2>YÃ¼kleme KayÄ±tlarÄ±</h2>
                    </div>
                    <button class="refresh-btn" id="refreshBtn">
                        <span>ğŸ”„</span>
                        <span>Yenile</span>
                    </button>
                </div>

                <div id="tableContainer">
                    <table class="loadings-table">
                        <thead>
                            <tr>
                                <th>MÃ¼ÅŸteri</th>
                                <th>AraÃ§ PlakasÄ±</th>
                                <th>VarÄ±ÅŸ Yeri</th>
                                <th>SÃ¼rÃ¼cÃ¼</th>
                                <th>Sisteme GiriÅŸ (Loader)</th>
                                <th>Safwat</th>
                                <th>Pinar</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody id="loadingsTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div class="empty-state hidden" id="emptyState">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <h3>YÃ¼kleme kaydÄ± bulunamadÄ±</h3>
                    <p>YÃ¼kleme sorumlusu kayÄ±t gÃ¶nderdiÄŸinde burada gÃ¶rÃ¼necektir</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h2>YÃ¼kleme DetaylarÄ±</h2>
                <div class="modal-actions" style="display: flex; gap: 10px; margin-right: auto; margin-left: 20px;">
                    <button class="action-btn" onclick="printReport()"
                        style="background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px;">
                        <span>ğŸ–¨ï¸</span> YazdÄ±r
                    </button>
                    <button class="action-btn" onclick="exportToExcel()"
                        style="background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px;">
                        <span>ğŸ“Š</span> Excel
                    </button>
                </div>
                <button class="modal-close" id="closeModal">âœ•</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let loadingsData = [];

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();

                if (!data.authenticated || data.user.role !== 'manager') {
                    window.location.href = '/';
                    return;
                }

                // Set display name based on username
                const username = data.user.username.trim().toLowerCase();
                let displayName = username;

                if (username === 'manager') {
                    displayName = 'Safwat';
                } else if (username === 'pinar') {
                    displayName = 'Pinar';
                }

                document.getElementById('userName').textContent = displayName;
                currentUsername = username;
                loadLoadings();
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/';
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Load loadings
        async function loadLoadings() {
            try {
                const response = await fetch('/api/loadings');
                const data = await response.json();

                if (response.ok) {
                    loadingsData = data;
                    renderLoadings(data);
                    updateStats(data);
                } else {
                    console.error('Error loading data:', data.error);
                }
            } catch (error) {
                console.error('Fetch error:', error);
            }
        }

        function renderLoadings(loadings) {
            const tbody = document.getElementById('loadingsTableBody');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.getElementById('tableContainer');

            if (loadings.length === 0) {
                emptyState.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tableContainer.classList.remove('hidden');

            tbody.innerHTML = loadings.map(loading => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${loading.destination_customer || '-'}
                            ${!loading.viewed_at
                    ? ((loading.loading_versions && loading.loading_versions[0] && loading.loading_versions[0].count > 0)
                        ? '<span class="edited-badge">DÃœZENLENDÄ°</span>'
                        : '<span class="new-badge">YENÄ°</span>')
                    : ''}
                        </div>
                    </td>
                    <td>${loading.plate1 || '-'} ${loading.plate2 ? '/ ' + loading.plate2 : ''}</td>
                    <td>${loading.destination_company || '-'} - ${loading.destination_country || '-'}</td>
                    <td>${loading.driver_name || '-'}</td>
                    <td><span style="font-size: 13px; color: var(--text-secondary);">${formatDateTime(loading.created_at)}</span></td>
                    <td>${loading.safwat_recorded_at
                    ? '<span class="status-badge status-recorded">âœ“ Kaydedildi</span>'
                    : '<span class="status-badge status-pending">â³ Bekliyor</span>'}
                    </td>
                    <td>${loading.pinar_recorded_at
                    ? '<span class="status-badge status-recorded">âœ“ Kaydedildi</span>'
                    : '<span class="status-badge status-pending">â³ Bekliyor</span>'}
                    </td>
                    <td><button class="view-btn" onclick="viewDetails('${loading.id}')">DetaylarÄ± GÃ¶r</button></td>
                </tr>
            `).join('');
        }

        function updateStats(loadings) {
            document.getElementById('totalLoadings').textContent = loadings.length;

            const today = new Date().toISOString().split('T')[0];
            const todayCount = loadings.filter(l => l.loading_date === today).length;
            document.getElementById('todayLoadings').textContent = todayCount;

            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('tr-TR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        let currentVersions = [];
        let currentLoadingId = null;
        let currentLoading = null;

        async function viewDetails(id) {
            currentLoadingId = id;
            const loading = loadingsData.find(l => l.id === id);
            if (!loading) return;
            currentLoading = loading;

            // Mark as viewed in background
            if (!loading.viewed_at) {
                fetch(`/api/loadings/${id}/view`, { method: 'PATCH' })
                    .then(res => res.json())
                    .then(data => {
                        // Update local state
                        loading.viewed_at = new Date().toISOString();
                    })
                    .catch(err => console.error('Error marking as viewed:', err));
            }

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = '<div class="spinner" style="margin: 50px auto;"></div>';
            document.getElementById('detailModal').classList.add('show');

            try {
                // Fetch versions
                const response = await fetch(`/api/loadings/${id}/versions`);
                let versions = [];

                if (response.ok) {
                    try {
                        const data = await response.json();
                        if (Array.isArray(data)) {
                            versions = data;
                        } else {
                            console.warn('Versions API returned non-array:', data);
                        }
                    } catch (e) {
                        console.error('Error parsing versions JSON:', e);
                    }
                } else {
                    console.warn('Versions API returned error status:', response.status);
                }

                currentVersions = [
                    { version_number: 'current', data: loading, created_at: loading.created_at },
                    ...versions.map(v => ({ ...v, version_number: v.version_number, data: v.data, created_at: v.archived_at }))
                ];

                renderVersionTabs(0); // Show current version (index 0)
            } catch (error) {
                console.error('Critical Error in viewDetails:', error);
                modalBody.innerHTML = `
                    <div style="padding: 20px; color: #dc2626; text-align: center;">
                        <h3>Hata OluÅŸtu</h3>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px;">SayfayÄ± Yenile</button>
                    </div>
                `;
            }
        }

        function renderVersionTabs(activeIndex) {
            const modalBody = document.getElementById('modalBody');

            // Generate Tabs HTML
            let tabsHtml = '<div class="version-tabs">';
            currentVersions.forEach((v, index) => {
                const isCurrent = index === 0;
                const label = isCurrent ? 'Mevcut SÃ¼rÃ¼m' : `Versiyon ${v.version_number}`;
                const activeClass = index === activeIndex ? 'active' : '';
                tabsHtml += `
                    <button class="version-tab ${activeClass}" onclick="switchVersion(${index})">
                        ${label}
                    </button>
                `;
            });
            tabsHtml += '</div>';

            const activeVersionData = currentVersions[activeIndex].data;
            const isArchived = activeIndex > 0;
            const archivedDate = currentVersions[activeIndex].created_at;

            // Warning for archived versions
            let contentHtml = '';
            if (isArchived) {
                contentHtml += `
                    <div class="archive-warning">
                        âš ï¸ Bu, ${formatDateTime(archivedDate)} tarihinde arÅŸivlenmiÅŸ eski bir sÃ¼rÃ¼mdÃ¼r.
                    </div>
                `;
            }

            contentHtml += renderLoadingDetails(activeVersionData, !isArchived); // Pass isEditable=false for archived

            modalBody.innerHTML = tabsHtml + '<div class="version-content">' + contentHtml + '</div>';
        }

        function switchVersion(index) {
            renderVersionTabs(index);
        }

        let currentUsername = '';

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();

                if (!data.authenticated || data.user.role !== 'manager') {
                    window.location.href = '/';
                    return;
                }

                currentUsername = data.user.username;
                document.getElementById('userName').textContent = currentUsername === 'pinar' ? 'Saha Operasyon' : 'Ãœretim MÃ¼dÃ¼rÃ¼';

                // Load data after auth check
                loadLoadings();
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/';
            }
        }

        // Call checkAuth immediately
        checkAuth();

        function renderLoadingDetails(loading, isCurrentVersion = true) {
            let products = loading.products || [];
            if (!Array.isArray(products)) {
                try { products = JSON.parse(products); } catch (e) { products = []; }
                if (!Array.isArray(products)) products = [];
            }

            // Generate Photos HTML
            const photosHtml = loading.loaded_vehicle_photos && loading.loaded_vehicle_photos.length > 0 ? `
                <div class="detail-section">
                    <h3>ğŸ“· YÃ¼kleme FotoÄŸraflarÄ±</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 15px;">
                        ${loading.loaded_vehicle_photos.map(url => `
                            <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 1px solid #eee; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <a href="${url}" target="_blank" style="display: block; width: 100%; height: 100%;">
                                    <img src="${url}" style="width: 100%; height: 100%; object-fit: cover;" alt="YÃ¼kleme FotoÄŸrafÄ±">
                                </a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            // Pinar's Restricted View
            if (currentUsername === 'pinar') {
                return `
                    <!-- Vehicle Info -->
                    <div class="detail-section">
                        <h3>ğŸšš AraÃ§ Bilgileri</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>AraÃ§ PlakasÄ± 1</label>
                                <span>${loading.plate1 || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <label>AraÃ§ PlakasÄ± 2</label>
                                <span>${loading.plate2 || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Konteyner NumarasÄ±</label>
                                <span>${loading.container_no || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Tarih</label>
                                <span>${formatDate(loading.loading_date)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Products -->
                    <div class="detail-section">
                        <h3>ğŸ“¦ YÃ¼klenen Mallar</h3>
                        ${products.length > 0 ? `
                            <table class="products-table" style="margin-top: 12px;">
                                <thead>
                                    <tr>
                                        <th>Mal AdÄ±</th>
                                        <th>SayÄ±</th>
                                        <th>Pallet SayÄ±sÄ±</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${products.map(p => `
                                        <tr>
                                            <td>${p.name || '-'}</td>
                                            <td>${p.quantity || '-'}</td>
                                            <td>${p.pallets || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="color: var(--gray-400);">KayÄ±tlÄ± mal bulunamadÄ±</p>'}
                    </div>
                    ${photosHtml}
                    <!-- Record Button - Only show for current version -->
                    ${isCurrentVersion ? (() => {
                        // For Pinar's view, we know currentUsername is pinar
                        const isRecorded = !!loading.pinar_recorded_at;
                        const recordedAt = loading.pinar_recorded_at;

                        return `
                        <div class="detail-section record-section">
                            <h3>ğŸ“ Sistem KayÄ±t Durumu (Pinar)</h3>
                            ${isRecorded ? `
                                <div class="recorded-status">
                                    <span class="status-badge status-recorded large">âœ“ Kaydedildi</span>
                                    <p class="recorded-info">KayÄ±t tarihi: ${recordedAt ? new Date(recordedAt).toLocaleString('tr-TR') : '-'}</p>
                                    <button class="unrecord-btn" id="unrecordBtn" onclick="cancelRecording('${loading.id}')">
                                        <span>âœ•</span>
                                        <span>KaydÄ± Ä°ptal Et</span>
                                    </button>
                                </div>
                            ` : `
                                <button class="record-btn" id="recordBtn" onclick="markAsRecorded('${loading.id}')">
                                    <span>âœ“</span>
                                    <span>Kaydedildi</span>
                                </button>
                                <p class="record-hint">Bu bilgileri sisteme kaydettikten sonra buraya tÄ±klayÄ±n</p>
                            `}
                        </div>
                        `;
                    })() : ''}
                `;
            }

            // Default Manager View (Full Access)
            return `
                <!-- Team Info -->
                <div class="detail-section">
                    <h3>ğŸ‘¥ Ekip Bilgileri</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>YÃ¶netici</label>
                            <span>${loading.manager || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Birinci Eleman</label>
                            <span>${loading.worker1 || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Ä°kinci Eleman</label>
                            <span>${loading.worker2 || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>ÃœÃ§Ã¼ncÃ¼ Eleman</label>
                            <span>${loading.worker3 || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>DÃ¶rdÃ¼ncÃ¼ Eleman</label>
                            <span>${loading.worker4 || '-'}</span>
                        </div>
                        <!-- Moved Forklift Operator Here or separate? In HTML default it was here -->
                        <div class="detail-item">
                            <label>Forklift SÃ¼rÃ¼cÃ¼sÃ¼</label>
                            <span>${loading.forklift_operator || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Info -->
                <div class="detail-section">
                    <h3>ğŸšš AraÃ§ Bilgileri</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>AraÃ§ PlakasÄ± 1</label>
                            <span>${loading.plate1 || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>AraÃ§ PlakasÄ± 2</label>
                            <span>${loading.plate2 || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Konteyner NumarasÄ±</label>
                            <span>${loading.container_no || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Tarih</label>
                            <span>${formatDate(loading.loading_date)}</span>
                        </div>
                    </div>
                </div>

                <!-- Weight Info -->
                <div class="detail-section">
                    <h3>âš–ï¸ AÄŸÄ±rlÄ±k Bilgileri</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>ÃœrÃ¼n AÄŸÄ±rlÄ±ÄŸÄ±</label>
                            <span>${loading.product_weight || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>TartÄ±dan Sonra AraÃ§ AÄŸÄ±rlÄ±ÄŸÄ±</label>
                            <span>${loading.vehicle_weight_after || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- Destination Info -->
                <div class="detail-section">
                    <h3>ğŸ“ VarÄ±ÅŸ Bilgileri</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Åirket</label>
                            <span>${loading.destination_company || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Ãœlke</label>
                            <span>${loading.destination_country || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>MÃ¼ÅŸteri</label>
                            <span>${loading.destination_customer || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- Driver Info -->
                <div class="detail-section">
                    <h3>ğŸ§‘ SÃ¼rÃ¼cÃ¼ Bilgileri</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>SÃ¼rÃ¼cÃ¼ AdÄ±</label>
                            <span>${loading.driver_name || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>SÃ¼rÃ¼cÃ¼ Telefonu</label>
                            <span>${loading.driver_phone || '-'}</span>
                        </div>
                        <!-- Forklift was moved in Loader view, here we can keep it or sync. Keeping it in Team or Driver is fine for Manager view -->
                    </div>
                </div>

                <!-- Products -->
                <div class="detail-section">
                    <h3>ğŸ“¦ YÃ¼klenen Mallar</h3>
                    ${products.length > 0 ? `
                        <table class="products-table" style="margin-top: 12px;">
                            <thead>
                                <tr>
                                    <th>Mal AdÄ±</th>
                                    <th>SayÄ±</th>
                                    <th>Pallet SayÄ±sÄ±</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(p => `
                                    <tr>
                                        <td>${p.name || '-'}</td>
                                        <td>${p.quantity || '-'}</td>
                                        <td>${p.pallets || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="color: var(--gray-400);">KayÄ±tlÄ± mal bulunamadÄ±</p>'}
                </div>
                ${photosHtml}

                <!-- Times -->
                <div class="detail-section">
                    <h3>ğŸ• Zamanlar</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>GiriÅŸ ZamanÄ±</label>
                            <span>${loading.entry_time || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Ã‡Ä±kÄ±ÅŸ ZamanÄ±</label>
                            <span>${loading.exit_time || '-'}</span>
                        </div>
                    </div>
                </div>

                <!-- Comments -->
                ${loading.comments ? `
                    <div class="detail-section">
                        <h3>ğŸ’¬ Yorumlar</h3>
                        <p style="color: var(--gray-200); line-height: 1.8;">${loading.comments}</p>
                    </div>
                ` : ''}

                <!-- Record Button - Only show for current version -->
                ${isCurrentVersion ? (() => {
                    // Determine status based on current user (Safwat/Manager)
                    let isRecorded = false;
                    let recordedAt = null;

                    if (currentUsername === 'pinar') {
                        isRecorded = !!loading.pinar_recorded_at;
                        recordedAt = loading.pinar_recorded_at;
                    } else {
                        // Default to safwat
                        isRecorded = !!loading.safwat_recorded_at;
                        recordedAt = loading.safwat_recorded_at;
                    }

                    return `
                    <div class="detail-section record-section">
                        <h3>ğŸ“ Sistem KayÄ±t Durumu ${currentUsername !== 'pinar' ? '(Safwat)' : '(Pinar)'}</h3>
                        ${isRecorded ? `
                            <div class="recorded-status">
                                <span class="status-badge status-recorded large">âœ“ Kaydedildi</span>
                                <p class="recorded-info">KayÄ±t tarihi: ${recordedAt ? new Date(recordedAt).toLocaleString('tr-TR') : '-'}</p>
                                <button class="unrecord-btn" id="unrecordBtn" onclick="cancelRecording('${loading.id}')">
                                    <span>âœ•</span>
                                    <span>KaydÄ± Ä°ptal Et</span>
                                </button>
                            </div>
                        ` : `
                            <button class="record-btn" id="recordBtn" onclick="markAsRecorded('${loading.id}')">
                                <span>âœ“</span>
                                <span>Kaydedildi</span>
                            </button>
                            <p class="record-hint">Bu bilgileri sisteme kaydettikten sonra buraya tÄ±klayÄ±n</p>
                        `}
                    </div>
                    `;
                })() : ''}
            `;
        }



        // Mark as recorded
        async function markAsRecorded(id) {
            const btn = document.getElementById('recordBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div><span>Kaydediliyor...</span>';
            }

            try {
                const response = await fetch(`/api/loadings/${id}/record`, {
                    method: 'PATCH'
                });

                const data = await response.json();

                if (response.ok) {
                    // Update local data
                    const index = loadingsData.findIndex(l => l.id === id);
                    if (index !== -1) {
                        loadingsData[index] = data.loading;
                    }
                    // Refresh table and modal
                    renderLoadings(loadingsData);
                    viewDetails(id);
                } else {
                    alert(data.error || 'Bir hata oluÅŸtu');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<span>âœ“</span><span>Kaydedildi</span>';
                    }
                }
            } catch (error) {
                console.error('Record error:', error);
                alert('BaÄŸlantÄ± hatasÄ±');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span>âœ“</span><span>Kaydedildi</span>';
                }
            }
        }

        // Cancel recording
        async function cancelRecording(id) {
            const btn = document.getElementById('unrecordBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div><span>Ä°ptal ediliyor...</span>';
            }

            try {
                const response = await fetch(`/api/loadings/${id}/unrecord`, {
                    method: 'PATCH'
                });

                const data = await response.json();

                if (response.ok) {
                    // Update local data
                    const index = loadingsData.findIndex(l => l.id === id);
                    if (index !== -1) {
                        loadingsData[index] = data.loading;
                    }
                    // Refresh table and modal
                    renderLoadings(loadingsData);
                    viewDetails(id);
                } else {
                    alert(data.error || 'Bir hata oluÅŸtu');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<span>âœ•</span><span>KaydÄ± Ä°ptal Et</span>';
                    }
                }
            } catch (error) {
                console.error('Unrecord error:', error);
                alert('BaÄŸlantÄ± hatasÄ±');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span>âœ•</span><span>KaydÄ± Ä°ptal Et</span>';
                }
            }
        }

        // Print Report
        function printReport() {
            window.print();
        }

        // Export to Excel (Vertical Layout)
        function exportToExcel() {
            if (!currentLoading) {
                alert('Rapor verisi bulunamadÄ±');
                return;
            }

            const loading = currentLoading;
            const dataRows = []; // Array of [Label, Value]

            // Helper to add row
            const addRow = (label, value) => {
                dataRows.push([label, value || '-']);
            };
            const addSection = (title) => {
                dataRows.push(['', '']); // Spacer
                dataRows.push([title.toUpperCase(), '']); // Section Header
            };

            // Check if user is Pinar (Restricted View)
            if (currentUsername === 'pinar') {
                // 1. Vehicle Info
                addSection('AraÃ§ Bilgileri');
                addRow('Plaka (Ã‡ekici)', loading.plate1);
                addRow('Plaka (Dorse)', loading.plate2);
                addRow('Konteyner NumarasÄ±', loading.container_no);
                addRow('Tarih', formatDate(loading.loading_date));

                // 2. Products
                addSection('YÃ¼klenen Mallar');
                if (Array.isArray(loading.products) && loading.products.length > 0) {
                    dataRows.push(['Mal AdÄ±', 'Miktar', 'Palet SayÄ±sÄ±']);
                    loading.products.forEach(p => {
                        dataRows.push([p.name, p.quantity, p.pallets]);
                    });
                } else {
                    addRow('Mal Bilgisi', 'Yok');
                }



            } else {
                // FULL VIEW for Safwat/Production Manager

                // 1. General Info
                addSection('Genel Bilgiler');
                addRow('Rapor ID', loading.id);
                addRow('YÃ¼kleme Tarihi', formatDate(loading.loading_date));
                addRow('KayÄ±t OluÅŸturulma', formatDateTime(loading.created_at));
                addRow('OluÅŸturan (ID)', loading.created_by);

                // 2. Team Info
                addSection('YÃ¼kleme Ekibi');
                addRow('YÃ¶netici (Manager)', loading.manager);
                addRow('Eleman 1', loading.worker1);
                addRow('Eleman 2', loading.worker2);
                addRow('Eleman 3', loading.worker3);
                addRow('Eleman 4', loading.worker4);
                addRow('Forklift OperatÃ¶rÃ¼', loading.forklift_operator);

                // 3. Vehicle & Driver
                addSection('AraÃ§ ve SÃ¼rÃ¼cÃ¼');
                addRow('Plaka (Ã‡ekici)', loading.plate1);
                addRow('Plaka (Dorse)', loading.plate2);
                addRow('Konteyner NumarasÄ±', loading.container_no);
                addRow('SÃ¼rÃ¼cÃ¼ AdÄ±', loading.driver_name);
                addRow('SÃ¼rÃ¼cÃ¼ Telefonu', loading.driver_phone);

                // 4. Weight & Destination
                addSection('YÃ¼k ve VarÄ±ÅŸ');
                addRow('ÃœrÃ¼n AÄŸÄ±rlÄ±ÄŸÄ±', loading.product_weight);
                addRow('TartÄ± SonrasÄ± AraÃ§', loading.vehicle_weight_after);
                addRow('VarÄ±ÅŸ Åirketi', loading.destination_company);
                addRow('VarÄ±ÅŸ Ãœlkesi', loading.destination_country);
                addRow('MÃ¼ÅŸteri', loading.destination_customer);

                // 5. Times
                addSection('Zaman Ã‡izelgesi');
                addRow('GiriÅŸ Saati', loading.entry_time);
                addRow('Ã‡Ä±kÄ±ÅŸ Saati', loading.exit_time);

                // 6. Products
                addSection('YÃ¼klenen Mallar');
                if (Array.isArray(loading.products) && loading.products.length > 0) {
                    // Header for products sub-table
                    dataRows.push(['Mal AdÄ±', 'Miktar', 'Palet SayÄ±sÄ±']);
                    loading.products.forEach(p => {
                        dataRows.push([p.name, p.quantity, p.pallets]);
                    });
                } else {
                    addRow('Mal Bilgisi', 'Yok');
                }

                // 7. Status & Comments
                addSection('Durum ve Notlar');
                addRow('Yorumlar', loading.comments);
            }



            // Create Workbook
            const ws = XLSX.utils.aoa_to_sheet(dataRows);

            // Adjust column width for readability
            ws['!cols'] = [{ wch: 25 }, { wch: 50 }, { wch: 15 }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rapor DetayÄ±");

            // Filename
            const plate = (loading.plate1 || 'Plakasiz').replace(/[^a-z0-9]/gi, '_');
            const date = (loading.loading_date || 'Tarihsiz');
            XLSX.writeFile(wb, `Rapor_${plate}_${date}.xlsx`);
        }

        // Close modal
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('detailModal').classList.remove('show');
        });

        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') {
                document.getElementById('detailModal').classList.remove('show');
            }
        });

        // Refresh
        document.getElementById('refreshBtn').addEventListener('click', loadLoadings);

        // Auto-refresh every 30 seconds
        setInterval(loadLoadings, 30000);

        // Check auth on load
        checkAuth();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('âœ… ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('âŒ ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>

</html>